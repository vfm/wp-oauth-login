name: Release Plugin

on:
  push:
    branches:
      - main
    paths:
      - 'plugin/**'
      - '.github/workflows/release.yml'

permissions:
  contents: write

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from plugin header
        id: version
        run: |
          VERSION=$(grep -m 1 "Version:" plugin/wp-oauth-login.php | sed 's/.*Version: *//' | tr -d '[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Plugin version: $VERSION"

      - name: Check if release already exists
        id: check_release
        run: |
          if gh release view "v${{ steps.version.outputs.version }}" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release v${{ steps.version.outputs.version }} already exists, skipping..."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Release v${{ steps.version.outputs.version }} does not exist, creating..."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare plugin directory
        if: steps.check_release.outputs.exists == 'false'
        run: |
          # Create build directory with correct plugin name
          mkdir -p build/wp-oauth-login
          
          # Copy plugin files (excluding dev files)
          rsync -av --exclude='.git' \
                    --exclude='.gitignore' \
                    --exclude='.github' \
                    --exclude='node_modules' \
                    --exclude='tests' \
                    --exclude='*.md' \
                    --exclude='composer.json' \
                    --exclude='composer.lock' \
                    --exclude='package.json' \
                    --exclude='package-lock.json' \
                    --exclude='.phpcs.xml' \
                    --exclude='phpunit.xml' \
                    plugin/ build/wp-oauth-login/

      - name: Create ZIP archive
        if: steps.check_release.outputs.exists == 'false'
        run: |
          cd build
          zip -r wp-oauth-login-${{ steps.version.outputs.version }}.zip wp-oauth-login/
          echo "Created: wp-oauth-login-${{ steps.version.outputs.version }}.zip"
          ls -la

      - name: Generate changelog
        if: steps.check_release.outputs.exists == 'false'
        id: changelog
        run: |
          # Get commits since last tag (or all commits if no tags)
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            CHANGES=$(git log --pretty=format:"- %s" $LAST_TAG..HEAD -- plugin/)
          else
            CHANGES=$(git log --pretty=format:"- %s" -20 -- plugin/)
          fi
          
          # Write to file to handle multiline
          echo "## Changes" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          if [ -n "$CHANGES" ]; then
            echo "$CHANGES" >> CHANGELOG.md
          else
            echo "- Initial release" >> CHANGELOG.md
          fi
          echo "" >> CHANGELOG.md
          echo "## Installation" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "1. Download \`wp-oauth-login-${{ steps.version.outputs.version }}.zip\`" >> CHANGELOG.md
          echo "2. Go to WordPress Admin â†’ Plugins â†’ Add New â†’ Upload Plugin" >> CHANGELOG.md
          echo "3. Upload the ZIP file and activate" >> CHANGELOG.md

      - name: Create GitHub Release
        if: steps.check_release.outputs.exists == 'false'
        run: |
          gh release create "v${{ steps.version.outputs.version }}" \
            --title "WP OAuth Login v${{ steps.version.outputs.version }}" \
            --notes-file CHANGELOG.md \
            build/wp-oauth-login-${{ steps.version.outputs.version }}.zip
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          if [ "${{ steps.check_release.outputs.exists }}" == "true" ]; then
            echo "### â­ï¸ Release Skipped" >> $GITHUB_STEP_SUMMARY
            echo "Release v${{ steps.version.outputs.version }} already exists." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸš€ Release Created" >> $GITHUB_STEP_SUMMARY
            echo "**Version:** v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "**Asset:** wp-oauth-login-${{ steps.version.outputs.version }}.zip" >> $GITHUB_STEP_SUMMARY
          fi
